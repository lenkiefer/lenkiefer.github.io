<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Data swarms: Your firearms are useless against them!</title>
    
    <meta name="author" content="Len Kiefer">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link href="/assets/themes/lentheme/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    
    <link href="/assets/themes/lentheme/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    
    <link href="/assets/themes/lentheme/bootstrap/css/bs-sticky-footer.css" rel="stylesheet">
    
    
    <link href="/assets/themes/lentheme/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    
    
    

    
    

    
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div id="wrap">
      <nav class="navbar navbar-default" role="navigation">
        
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/"><span class="icon-home3" style="font-size:24px"> Len Kiefer</a></span>
        </div>

        
        <div class="collapse navbar-collapse" id="jb-navbar-collapse" style="font-size:24px">
          <ul class="nav navbar-nav" >
        <li><a href="/archive.html"><span class="icon-newspaper"> Posts</a></span></li>
            
         <li><a href="/resume.html"><span class="icon-profile"> Resume</span></a></li>
        <li><a href="/about.html"><span class="icon-user-tie"> About</span></a></li>
          </ul>
        </div>
      </nav>

      <div class="container">
        
<div class="page-header">
  <h1>Data swarms: Your firearms are useless against them! </h1>
</div>

<div class="row post-full">
  <div class="col-xs-12">
    <div class="date">
      <span>18 August 2016</span>
    </div>
    <div class="content">
      <p>AUGUST IS ALMOST OVER, and it’s nearly back to school season.  And that means one thing.  No, not that we’re about to get a chance to watch the <a href="http://www.ncaa.com/news/football/article/2016-08-02/college-football-ohio-state-tops-aps-all-time-top-100">#1 NCAA football program of all time</a> dominate the gridiron (though that’s awesome too). No, it’s data release season!  A data swarm is on its way.</p>

<p>From <a href="http://www.census.gov/programs-surveys/acs/news/data-releases/2015/release-schedule.html">American Community Survey</a> to the <a href="http://www.census.gov/programs-surveys/ahs/news/2015-data-release.html">American Housing Survey</a> to the annual <a href="https://www.ffiec.gov/hmda/faqtech.htm#p3">Home Mortgage Disclosure Act Data</a> many statistical data releases come out in September and October.</p>

<p>In preparation for all these data releases I’ve been firing up the viz terminal and getting my statistical software all stretched out.  Good news is, there’s all kind of great innovations coming out to help me. Bad news is there’s so much to keep up with.  In this post I’m going to try out some new techniques and work on some fundamentals.</p>

<h1 id="data-wrangling-with-r">Data wrangling with R</h1>

<p>Out of expediency I’ve often used Excel for mundane data wrangling tasks (<a href="/2016/05/08/visual-meditations-on-house-prices-part1">see here for an example</a>), but I’ve been meaning to use R more.</p>

<p>Fortunately I’ve gotten some help to jump start me. <a href="https://twitter.com/jkregenstein">@jkregenstein</a>, who works at <a href="https://www.rstudio.com/">Rstudio</a> reached out to me and offered me some R code (see <a href="https://beta.rstudioconnect.com/content/1341/Freddie_Data_Notebook.nb.html">here for house prices example</a> and  <a href="https://beta.rstudioconnect.com/content/1445/ConsumerCreditDataNotebook.nb.html">here for credit panel example</a> from Jonathan) to accomplish what I was doing with Excel.</p>

<p>I’m going to try to build from Jonathan’s examples and work out my data wrangling skills with an example using negative equity estimates from Zillow.</p>

<h2 id="wrangling-some-data">Wrangling some data</h2>

<p>Zillow publishes a <a href="http://www.zillow.com/research/methodology-negative-equity-3180/">negative equity report</a> that tracks what proportion of homeowners currently are “underwater” or owe more on their mortgage than what their home is currently worth.  See a write-up of their latest release from Zillow Chief Economist <a href="https://twitter.com/SvenjaGudell">@SvenjaGudell </a> <a href="http://www.zillow.com/research/q2-2016-negative-equity-report-13046/">here</a>. Note that the firm <a href="http://www.corelogic.com/about-us/researchtrends/homeowner-equity-report.aspx">CoreLogic also has a report</a>. The two reports are slightly different due to different underlying data and different, but similar, methodologies.  Because the Zillow data is available in a handy .csv format <a href="http://www.zillow.com/research/data/#additional-data">downloadable</a> from their website I’m going to use the Zillow data.</p>

<p>The Zillow data is not <a href="http://vita.had.co.nz/papers/tidy-data.pdf">tidy</a>, but it’s not too far from it. It’s a good version to practice on. Downloading the <a href="http://files.zillowstatic.com/research/public/NegativeEquity_2016Q1_Public.csv">data</a> you get a .csv file that looks like this when viewed in Excel. <strong>Note Zillow released the 2016Q2 <a href="http://www.zillow.com/research/q2-2016-negative-equity-report-13046/">report today</a>, but the latest available data at time of writing is the 2016Q1 report</strong></p>

<p><img src="/img/charts_aug_18_2016/zillow ne report.PNG" alt="zillow data" style="width: 550px;" /></p>

<p>In the data file there are several descriptive columns and then the actual data showing the proportion of homeowners underwater according to Zillow’s calculations starting in the 13th column (M in the spreadsheet). We’ll want to tidy this column by gathering all the data columns (from columns 13 to 32 or column M to AF).</p>

<p>My standard approach with this would be to use the Excel pivot table wizard to gather the columns like so (from my <a href="/2016/05/08/visual-meditations-on-house-prices-part1">house price data wrangling post</a>):</p>

<p><img src="/img/charts_may_8_2016/tidy1.gif" alt="FMHPI 6" style="width: 550px;" /></p>

<p>But tidying these data in R is pretty easy.</p>

<p>Here’s how I would have gone about it:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#load libraries
</span><span class="n">library</span><span class="p">(</span><span class="n">readr</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">lubridate</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">stringr</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">readxl</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">ggrepel</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">ggthemes</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">zoo</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">data.table</span><span class="p">)</span>

<span class="c1">#zdata&lt;-fread("http://files.zillowstatic.com/research/public/NegativeEquity_2016Q1_Public.csv")
</span>
<span class="c1"># Here's how I would have done it by brut(ish) force
</span><span class="n">z2</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">gather</span><span class="p">(</span><span class="n">zdata</span><span class="p">,</span><span class="n">dateq</span><span class="p">,</span><span class="s2">"neg"</span><span class="p">,</span><span class="m">13</span><span class="o">:</span><span class="m">32</span><span class="p">))</span>
<span class="n">z2</span><span class="p">[,</span><span class="n">year</span><span class="o">:=</span><span class="n">as.numeric</span><span class="p">(</span><span class="n">substring</span><span class="p">(</span><span class="n">dateq</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">4</span><span class="p">))]</span>
<span class="n">z2</span><span class="p">[,</span><span class="n">month</span><span class="o">:=</span><span class="n">as.numeric</span><span class="p">(</span><span class="n">substring</span><span class="p">(</span><span class="n">dateq</span><span class="p">,</span><span class="m">6</span><span class="p">,</span><span class="m">6</span><span class="p">))]</span>
<span class="n">z2</span><span class="o">$</span><span class="n">date</span><span class="o">&lt;-</span> <span class="n">as.Date</span><span class="p">(</span><span class="n">ISOdate</span><span class="p">(</span><span class="n">z2</span><span class="o">$</span><span class="n">year</span><span class="p">,</span><span class="n">z2</span><span class="o">$</span><span class="n">month</span><span class="p">,</span><span class="m">1</span><span class="p">)</span> <span class="p">)</span>  <span class="err">#</span><span class="n">this</span> <span class="n">converts</span> <span class="n">year</span> <span class="n">and</span> <span class="n">month</span> <span class="n">characters</span> <span class="n">to</span> <span class="n">R</span> <span class="n">dates</span></code></pre></figure>

<p>But after reading Jonathan’s code examples I see that I can try a slightly different approach to get to the same place.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">##manipulate and create new variables
</span><span class="n">zdata_wrangled</span> <span class="o">&lt;-</span><span class="n">zdata</span>  <span class="o">%&gt;%</span> 
  <span class="n">gather</span><span class="p">(</span><span class="n">dateq</span><span class="p">,</span><span class="s2">"neg"</span><span class="p">,</span><span class="m">13</span><span class="o">:</span><span class="m">32</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="c1">#create a column called year and month by separating the zillow date column
</span>  <span class="n">separate</span><span class="p">(</span><span class="n">dateq</span><span class="p">,</span><span class="n">into</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="s2">"year"</span><span class="p">,</span><span class="s2">"quarter"</span><span class="p">),</span><span class="n">sep</span><span class="o">=</span><span class="s2">"Q"</span><span class="p">,</span><span class="n">convert</span><span class="o">=</span><span class="n">T</span><span class="p">,</span><span class="n">remove</span><span class="o">=</span><span class="n">F</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="c1">#create dates
</span>  <span class="n">mutate</span><span class="p">(</span>
    <span class="n">date</span><span class="o">=</span> <span class="n">as.Date</span><span class="p">(</span><span class="n">ISOdate</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">quarter</span><span class="o">*</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">data.table</span><span class="p">()</span></code></pre></figure>

<h3 id="okay-lets-use-these-data-for-something">Okay let’s use these data for something</h3>

<p>Let’s examine trends in negative equity by state using these data. Once again we’ll use the R packaged tweenr and animate to make an animated gif. See my earlier <a href="/2016/05/29/improving-R-animated-gifs-with-tweenr">post about tweenr</a> for an introduction to tweenr, and more examples <a href="/2016/05/30/more-tweenr-animations">here</a> and <a href="/2016/06/26/week-in-review">here</a>.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">USID</span><span class="o">&lt;-</span><span class="n">unique</span><span class="p">(</span><span class="n">z3</span><span class="p">[</span><span class="n">RegionType</span><span class="o">==</span><span class="s2">"Country"</span><span class="p">]</span><span class="o">$</span><span class="n">RegionID</span><span class="p">)</span>   <span class="c1">#get the US region ID
</span><span class="n">regions</span><span class="o">&lt;-</span><span class="n">unique</span><span class="p">(</span><span class="n">z3</span><span class="p">[</span><span class="n">RegionType</span><span class="o">==</span><span class="s2">"State"</span><span class="p">]</span><span class="o">$</span><span class="n">RegionID</span><span class="p">)</span>  <span class="c1">#get a list of state IDs
</span>
<span class="c1">#add the "US" at the top and the bottomw of the list of states 
</span><span class="n">r2</span><span class="o">&lt;-</span><span class="n">c</span><span class="p">(</span><span class="n">USID</span><span class="p">,</span><span class="n">regions</span><span class="p">,</span><span class="n">USID</span><span class="p">)</span>

<span class="c1"># function to create list of data sets from our data (by state)
</span><span class="n">myf</span><span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">r</span><span class="p">){</span>
  <span class="n">z.out</span><span class="o">&lt;-</span><span class="n">z3</span><span class="p">[</span><span class="n">RegionType</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">c</span><span class="p">(</span><span class="s2">"Country"</span><span class="p">,</span><span class="s2">"State"</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RegionID</span><span class="o">==</span><span class="n">r</span><span class="p">,</span> <span class="n">list</span><span class="p">(</span><span class="n">RegionName</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">neg</span><span class="p">)]</span>
  <span class="n">z.out</span> <span class="o">%&gt;%</span> <span class="n">map_if</span><span class="p">(</span><span class="n">is.character</span><span class="p">,</span> <span class="n">as.factor</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">as.data.frame</span><span class="p">()</span> <span class="o">-&gt;</span><span class="n">z.out</span>
  <span class="k">return</span><span class="p">(</span><span class="n">z.out</span><span class="p">)</span>
  <span class="p">}</span>
<span class="n">myf</span><span class="p">(</span><span class="n">regions</span><span class="p">[</span><span class="m">1</span><span class="p">])</span>
<span class="c1"># use lapply to generate the list of data sets:
</span><span class="n">my.list2</span><span class="o">&lt;-</span><span class="n">lapply</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">myf</span><span class="p">)</span>

<span class="c1"># Apply tweenr:
</span><span class="n">tf</span> <span class="o">&lt;-</span> <span class="n">tween_states</span><span class="p">(</span><span class="n">my.list2</span><span class="p">,</span> <span class="n">tweenlength</span><span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">statelength</span><span class="o">=</span><span class="m">3</span><span class="p">,</span> <span class="n">ease</span><span class="o">=</span><span class="n">rep</span><span class="p">(</span><span class="s1">'cubic-in-out'</span><span class="p">,</span><span class="m">51</span><span class="p">),</span><span class="n">nframes</span><span class="o">=</span><span class="m">300</span><span class="p">)</span>
<span class="n">dtf</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span>  <span class="c1"># Make tweenr output a data table 
</span>
<span class="n">oopt</span> <span class="o">=</span> <span class="n">ani.options</span><span class="p">(</span><span class="n">interval</span> <span class="o">=</span> <span class="m">0.15</span><span class="p">)</span>
<span class="n">saveGIF</span><span class="p">({</span><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1</span><span class="o">:</span><span class="n">max</span><span class="p">(</span><span class="n">tf</span><span class="o">$</span><span class="n">.frame</span><span class="p">))</span> <span class="p">{</span>
<span class="c1"># create the animation
</span><span class="n">g</span><span class="o">&lt;-</span>
  <span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dtf</span><span class="p">,</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">neg</span><span class="p">,</span><span class="n">group</span><span class="o">=</span><span class="n">RegionName</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">RegionName</span><span class="p">))</span><span class="o">+</span>
  <span class="n">geom_path</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">z3</span><span class="p">[</span><span class="n">RegionID</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">r2</span><span class="p">,],</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">neg</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="m">0.3</span><span class="p">)</span>  <span class="o">+</span>
  <span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">percent</span><span class="p">)</span><span class="o">+</span>
  <span class="n">geom_line</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dtf</span><span class="p">[</span><span class="n">.frame</span><span class="o">==</span><span class="n">i</span><span class="p">,],</span><span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">1.1</span><span class="p">)</span><span class="o">+</span>
  <span class="c1">#add % at end
</span>  <span class="n">geom_text</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dtf</span><span class="p">[</span><span class="n">date</span><span class="o">==</span><span class="n">max</span><span class="p">(</span><span class="n">dtf</span><span class="o">$</span><span class="n">date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">.frame</span><span class="o">==</span><span class="n">i</span><span class="p">],</span><span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">percent</span><span class="p">(</span><span class="n">neg</span><span class="p">)),</span>
            <span class="n">nudge_y</span><span class="o">=</span><span class="m">.025</span><span class="p">,</span><span class="n">nudge_x</span><span class="o">=</span><span class="m">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span><span class="o">+</span>
  <span class="c1">#add point at line end:
</span>  <span class="n">geom_point</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dtf</span><span class="p">[</span><span class="n">date</span><span class="o">==</span><span class="n">max</span><span class="p">(</span><span class="n">dtf</span><span class="o">$</span><span class="n">date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">.frame</span><span class="o">==</span><span class="n">i</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span><span class="o">+</span>
  <span class="c1">#style:
</span>  <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span>  <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">face</span><span class="o">=</span><span class="s2">"bold"</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">))</span><span class="o">+</span>
  <span class="n">theme</span><span class="p">(</span><span class="n">plot.subtitle</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">))</span><span class="o">+</span>
  <span class="c1">#labels:
</span>  <span class="n">labs</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">"Percent of homeowners underwater"</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
       <span class="n">caption</span><span class="o">=</span><span class="s2">"@lenkiefer Source: Zillow Negative Equity Report (2016Q1)"</span><span class="p">,</span>
       <span class="n">subtitle</span><span class="o">=</span><span class="n">unique</span><span class="p">(</span><span class="n">dtf</span><span class="p">[</span><span class="n">.frame</span><span class="o">==</span><span class="n">i</span><span class="p">]</span><span class="o">$</span><span class="n">RegionName</span><span class="p">),</span>
       <span class="n">title</span><span class="o">=</span><span class="s2">"Negative Equity by State"</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
<span class="n">ani.pause</span><span class="p">()</span>
<span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="p">}</span>
<span class="p">},</span><span class="n">movie.name</span><span class="o">=</span><span class="s2">"zillow neg equity 2016Q1.gif"</span><span class="p">,</span><span class="n">ani.width</span> <span class="o">=</span> <span class="m">500</span><span class="p">,</span> <span class="n">ani.height</span> <span class="o">=</span> <span class="m">350</span><span class="p">)</span></code></pre></figure>

<p>Which yields:</p>

<p><img src="/img/charts_aug_18_2016/zillow neg equity 2016Q1.gif" alt="neg equity gif" /></p>

<h1 id="swarms-and-swarms">Swarms and swarms</h1>

<p>I spend a lot of time looking at the annual Home Mortgage Disclosure Act (HMDA) data. The publicly available data is a great source of information for what’s happened in the mortgage market in the past year. The data are only available with a lag.  In September/October we’ll get the 2015 data.</p>

<p>The data are housed over at the Consumer Financial Protection Bureau <a href="http://www.consumerfinance.gov/data-research/hmda/explore">webpage</a>. They have a public <a href="http://www.consumerfinance.gov/data-research/hmda/api">API</a>, but I haven’t seen anything written on using R with it. But they do have a nice summary file generator, which can be quite handy. But for this exercise we’ll work with the loan level data.</p>

<p>For this exercise we’re going to work with mortgage loan origination records from the 2014 HMDA data.</p>

<p>Every year there are a lot of mortgages originated. <a href="https://twitter.com/lenkiefer/status/765204080604147712">Some</a> have even said that this year (2016) the total market will top $2 Trillion in originated mortgages. In 2014 there were over 5 million mortgage loans originated for 1-4 family dwellings and manufactured housing. For the following examples I downloaded a loan-level file including all 5 million + observations from the CFPB website. To make things marginally faster I restricted myself to conventional loans, bringing the raw count down to about 4 million loans.</p>

<h2 id="beeswarm-plots">Beeswarm plots</h2>

<p>Yesterday <a href="https://twitter.com/hadleywickham">@hadleywickham</a> <a href="https://twitter.com/hadleywickham/status/765893450172473344">commented</a> on how he was enjoying the <a href="https://github.com/eclarke/ggbeeswarm">ggbeeswarm package</a> which allows you to make beeswarm plots (or column scatter plots or violin scatter plots) in R with ggplot2.</p>

<p>I like to look at distributions in different ways, so I thought I would try them out. I was not disappointed, especially when I combined it with tweenr.</p>

<p>For this example, I’m going to use the beeswarm package to generate beeswarm plots shows the distribution of loan amount across states broken out by purchase and refinance loans. And we’ll use tweenr to animate the transitions.</p>

<p><img src="/img/charts_aug_18_2016/HMDA loan amounts v3.gif" alt="HMDA Swarm" /></p>

<h2 id="making-the-plot">Making the plot</h2>

<p>I’ve pulled down a .csv file from the CFPB website that containes all the conventional purchase and refinance 1-4 family dwelling and manufactured housing mortgage originations in 2014. <a href="http://www.consumerfinance.gov/data-research/hmda/explore#!/as_of_year=2014&amp;property_type=1,3&amp;action_taken=1&amp;loan_purpose=1,3&amp;loan_type=1&amp;section=filters">This link</a> will take you to the CFPB webpage where you can download the file. It is about 2.6 GB so I wouldn’t recommend opening in Excel. <em>Though I have done such a thing in the past.</em></p>

<p>But I’m not here to talk about the past (that’s a story for another post). I’m here to talk about beeswarms.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="s1">'ggbeeswarm'</span><span class="p">)</span>  <span class="c1">#load the ggbeeswarm package
</span><span class="n">library</span><span class="p">(</span><span class="s1">'viridis'</span><span class="p">)</span>     <span class="c1"># viridis for colors
</span><span class="n">mydata</span> <span class="o">&lt;-</span> <span class="n">fread</span><span class="p">(</span><span class="s2">"~/data/hmda/hmda_lar.csv"</span><span class="p">)</span>  <span class="c1">#load the .csv file data tables do well.
</span>

<span class="c1">#let's only keep important columns
</span><span class="n">mydata</span><span class="o">&lt;-</span><span class="n">mydata</span><span class="p">[,</span><span class="n">list</span><span class="p">(</span><span class="n">state_name</span><span class="p">,</span><span class="n">loan_purpose_name</span><span class="p">,</span><span class="n">loan_type_name</span><span class="p">,</span><span class="n">loan_amount_000s</span><span class="p">)]</span>
<span class="n">mydata</span><span class="o">$</span><span class="n">upb</span><span class="o">&lt;-</span><span class="n">as.numeric</span><span class="p">(</span><span class="n">mydata</span><span class="o">$</span><span class="n">loan_amount_000s</span><span class="p">)</span><span class="o">*</span><span class="m">1000</span>

<span class="c1">#subset data for smaller version:
</span><span class="n">mydata2</span><span class="o">&lt;-</span><span class="n">mydata</span><span class="p">[</span> <span class="n">loan_type_name</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">c</span><span class="p">(</span><span class="s2">"Conventional"</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">state_name</span> <span class="o">!=</span><span class="s2">""</span><span class="p">,</span> <span class="p">]</span>  <span class="c1">#my original query included non-conventional (e.g. FHA, VA, or RHS loans)
</span>
<span class="n">rm</span><span class="p">(</span><span class="n">mydata</span><span class="p">)</span>  <span class="c1">#drop unecessary data
</span>
<span class="c1">#convert characters to factors for tweenr
</span>
<span class="n">mydata2</span> <span class="o">%&gt;%</span> <span class="n">map_if</span><span class="p">(</span><span class="n">is.character</span><span class="p">,</span> <span class="n">as.factor</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">as_data_frame</span> <span class="o">-&gt;</span> <span class="n">mydata2</span>

<span class="n">myf</span> <span class="o">&lt;-</span> <span class="k">function</span><span class="p">(</span><span class="n">mystate</span><span class="p">){</span>
  <span class="n">my.out</span><span class="o">&lt;-</span><span class="n">mydata2</span><span class="p">[</span><span class="n">state_name</span><span class="o">==</span><span class="n">mystate</span><span class="p">,</span><span class="n">list</span><span class="p">(</span><span class="n">upb</span><span class="p">,</span><span class="n">loan_purpose_name</span><span class="p">,</span><span class="n">loan_type_name</span><span class="p">,</span><span class="n">state_name</span><span class="p">)][</span><span class="n">sample</span><span class="p">(</span><span class="n">.N</span><span class="p">,</span><span class="m">3000</span><span class="p">)]</span>
  <span class="c1">#The data is huge, so I only want to sample 3000 loans.  Plotting millions of points isn't very useful.
</span>
    <span class="n">my.out</span> <span class="o">%&gt;%</span> <span class="n">map_if</span><span class="p">(</span><span class="n">is.character</span><span class="p">,</span> <span class="n">as.factor</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">as.data.frame</span><span class="p">()</span> <span class="o">-&gt;</span><span class="n">my.out</span>  <span class="c1">#need to convert characters to factors for tweenr
</span>  <span class="k">return</span><span class="p">(</span><span class="n">data.frame</span><span class="p">(</span><span class="n">my.out</span><span class="p">))}</span>

<span class="c1">#I want to order states by total loan origination Unpaid Principal Balance (upb)
#Calinfornia goes first
</span><span class="n">st.sums1</span><span class="o">&lt;-</span><span class="n">mydata2</span><span class="p">[,</span> <span class="n">list</span><span class="p">(</span><span class="n">upb</span><span class="o">=</span><span class="n">sum</span><span class="p">(</span><span class="n">as.numeric</span><span class="p">(</span><span class="n">loan_amount_000s</span><span class="p">))</span><span class="o">/</span><span class="m">1e6</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="n">state_name</span><span class="p">]</span> 

<span class="n">st.list</span><span class="o">&lt;-</span><span class="n">as.character</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">st.sums1</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="o">-</span><span class="n">upb</span><span class="p">)]</span><span class="o">$</span><span class="n">state_name</span><span class="p">))</span>  <span class="c1">#unique list of states
</span><span class="n">my.list</span><span class="o">&lt;-</span><span class="n">lapply</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="n">st.list</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">51</span><span class="p">],</span><span class="n">st.list</span><span class="p">[</span><span class="m">1</span><span class="p">]),</span><span class="n">myf</span><span class="p">)</span> 

<span class="c1"># tween
</span><span class="n">tf</span> <span class="o">&lt;-</span> <span class="n">tween_states</span><span class="p">(</span><span class="n">my.list</span><span class="p">,</span> <span class="n">tweenlength</span><span class="o">=</span> <span class="m">3</span><span class="p">,</span> <span class="n">statelength</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">ease</span><span class="o">=</span><span class="n">rep</span><span class="p">(</span><span class="s1">'cubic-in-out'</span><span class="p">,</span><span class="m">24</span><span class="p">),</span><span class="n">nframes</span><span class="o">=</span><span class="m">300</span><span class="p">)</span>
<span class="n">tf</span><span class="o">&lt;-</span><span class="n">data.table</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span>

<span class="c1">#a plot for the function
</span><span class="n">myplot</span><span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">i</span><span class="p">){</span>
  <span class="n">g</span><span class="o">&lt;-</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">tf</span><span class="p">[</span><span class="n">.frame</span><span class="o">==</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">upb</span><span class="o">&gt;</span><span class="m">0</span><span class="p">],</span>
           <span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">loan_purpose_name</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">upb</span><span class="o">/</span><span class="m">1000</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">loan_purpose_name</span><span class="p">))</span><span class="o">+</span>
    <span class="n">theme_minimal</span><span class="p">()</span><span class="o">+</span>    
    <span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">14</span><span class="p">))</span><span class="o">+</span><span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">vjust</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="m">10</span><span class="p">)))</span><span class="o">+</span>
    <span class="n">theme</span><span class="p">(</span><span class="n">plot.margin</span><span class="o">=</span><span class="n">unit</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">),</span><span class="s2">"cm"</span><span class="p">))</span><span class="o">+</span>
    <span class="n">geom_quasirandom</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="m">0.35</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">.7</span><span class="p">)</span><span class="o">+</span>  <span class="c1">#I like the quasirandom beeswarm option
</span>    <span class="n">scale_color_viridis</span><span class="p">(</span><span class="n">discrete</span><span class="o">=</span><span class="n">T</span><span class="p">,</span><span class="n">option</span><span class="o">=</span><span class="s2">"D"</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span><span class="o">+</span>  <span class="c1">#use viridis color package, it's great!
</span>    <span class="n">theme</span><span class="p">(</span><span class="n">legend.justification</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">),</span> <span class="n">legend.position</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span><span class="o">+</span>
    <span class="c1"># use a log scale
</span>    <span class="n">scale_x_log10</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">10</span><span class="p">,</span><span class="m">2500</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="n">dollar</span><span class="p">,</span><span class="n">breaks</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">10</span><span class="p">,</span><span class="m">25</span><span class="p">,</span><span class="m">50</span><span class="p">,</span><span class="m">100</span><span class="p">,</span><span class="m">250</span><span class="p">,</span><span class="m">500</span><span class="p">,</span><span class="m">1000</span><span class="p">,</span><span class="m">2000</span><span class="p">))</span><span class="o">+</span> 
    <span class="c1">#labels
</span>    <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Loan Amount (Ths $, log scale)"</span><span class="p">,</span>
         <span class="n">y</span><span class="o">=</span><span class="s2">"Loan Purpose"</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s2">"Distribution of conventional mortgage loan amount"</span><span class="p">,</span>
         <span class="n">subtitle</span><span class="o">=</span><span class="n">paste</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">tf</span><span class="p">[</span><span class="n">.frame</span><span class="o">==</span><span class="n">i</span><span class="p">]</span><span class="o">$</span><span class="n">state</span><span class="p">),</span><span class="s2">"in 2014"</span><span class="p">),</span>
        <span class="n">caption</span><span class="o">=</span><span class="s2">"@lenkiefer Source: CFPB, FFIEC, Home Mortgage Disclosure Act (HMDA) data\nEach dot represents one originated loan. (3,000 loans randomly sampled for plot)\nIncludes only Conventional purchase and refinance loans for 1-4 family dwellings and manufactured housing."</span><span class="p">)</span>
   <span class="k">return</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>  <span class="p">}</span>

<span class="c1"># make the movie
</span>
<span class="n">library</span><span class="p">(</span><span class="n">animation</span><span class="p">)</span>
<span class="n">oopt</span> <span class="o">=</span> <span class="n">ani.options</span><span class="p">(</span><span class="n">interval</span> <span class="o">=</span> <span class="m">0.2</span><span class="p">)</span>
<span class="n">saveGIF</span><span class="p">({</span><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1</span><span class="o">:</span><span class="n">max</span><span class="p">(</span><span class="n">tf</span><span class="o">$</span><span class="n">.frame</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">g</span><span class="o">&lt;-</span><span class="n">myplot</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
  <span class="n">print</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
  <span class="n">ani.pause</span><span class="p">()</span>
  <span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="p">}</span>
<span class="p">},</span><span class="n">movie.name</span><span class="o">=</span><span class="s2">"HMDA loan amounts v3.gif"</span><span class="p">,</span><span class="n">ani.width</span> <span class="o">=</span> <span class="m">740</span><span class="p">,</span> <span class="n">ani.height</span> <span class="o">=</span> <span class="m">450</span><span class="p">)</span></code></pre></figure>


    </div>

    

    
  
    <hr>
    <ul class="pagination">
    
      <li class="prev"><a href="/2016/08/15/trends-in-credit-part-2" title="Consumer Credit Trends Part 2: Data doesn't drive, it's lucky to be in the car">&laquo; Previous</a></li>
    
      <li><a href="/archive.html">Archive</a></li>
    
      <li class="next"><a href="/2016/08/19/mortgage-gif-8-19-2016" title="Mortgage rate gifs: Week of Aug 19, 2016">Next &raquo;</a></li>
    
    </ul>
    <hr>
    
  </div>
</div>



      </div>

    </div>

    <div id="footer">
      <div class="container">
        <p>&copy; 2017 Len Kiefer
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>
       
    • <span vertical-align:bottom> <a href="https://twitter.com/lenkiefer" class="twitter-follow-button" data-show-count="false">•   Follow @lenkiefer</a>
  
 <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</span>
• <script src="//platform.linkedin.com/in.js" type="text/javascript"></script>
<script type="IN/MemberProfile" data-id="https://www.linkedin.com/pub/leonard-kiefer/31/753/511" data-format="click" data-related="false" data-text="Leonard Kiefer"></script>
  • lenkiefer@hotmail.com
           </p>
      </div>
    </div>
    





<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-66905937-1', 'auto');
  ga('send', 'pageview');

</script>

    
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="/assets/themes/lentheme/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>





